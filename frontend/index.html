<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mixtli — Subir y compartir</title>
<style>:root{color-scheme:dark}body{margin:0;background:#0b0e14;color:#e6eefc;font-family:ui-sans-serif,system-ui,Arial}.wrap{max-width:920px;margin:30px auto;padding:24px}.card{background:#0f131b;border:1px solid #1b2333;border-radius:18px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)}.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}.log{white-space:pre-wrap;background:#0b0f17;padding:12px;border-radius:12px;border:1px solid #2a3347;min-height:140px}.drop{margin:10px 0;padding:24px;border:2px dashed #2a3347;border-radius:16px;text-align:center;color:#bcd}.drop.drag{border-color:#6fa3ff;color:#dff}.preview img{max-width:100%;border-radius:12px;border:1px solid #223047}.pill{display:inline-block;background:#111827;border:1px solid #1f2937;border-radius:999px;padding:4px 10px;font-size:12px;color:#bcd}</style>
</head><body>
<div class="wrap"><div class="card">
  <div class="row"><h1>Mixtli — Subir y compartir</h1><span class="pill" id="status">listo</span></div>
  <div class="row"><input id="api" style="flex:1" value="https://mixtli-pro.onrender.com"/><button id="save">Guardar API</button></div>
  <div class="drop" id="drop">Arrastra un archivo aquí</div>
  <div class="row"><input id="file" type="file"/><button id="go">Subir y generar enlace</button></div>
  <div id="out" class="log"></div><div id="result"></div>
</div></div>
<script>
const $=id=>document.getElementById(id);
$("save").onclick=()=>log("API:",$("api").value);
["dragenter","dragover"].forEach(e=>$("drop").addEventListener(e,ev=>{ev.preventDefault();$("drop").classList.add("drag")}));
["dragleave","drop"].forEach(e=>$("drop").addEventListener(e,ev=>{ev.preventDefault();$("drop").classList.remove("drag")}));
$("drop").addEventListener("drop",ev=>{ const f=ev.dataTransfer.files?.[0]; if(f) {$("file").files=ev.dataTransfer.files; go()} });
$("go").onclick=go;
function log(){ $("out").textContent += Array.from(arguments).map(x=>typeof x==="string"?x:JSON.stringify(x,null,2)).join(" ")+"\n" }
async function go(){
  $("out").textContent=""; $("result").innerHTML="";
  const f=$("file").files[0]; if(!f) return alert("Selecciona un archivo");
  const api=$("api").value.replace(/\/$/,"");
  try{
    const p=await fetch(api+"/presign",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:f.name,contentType:f.type,size:f.size})});
    const pj=await p.json(); log("presign:",pj);
    const put=await fetch(pj.url,{method:"PUT",headers:{"Content-Type":f.type},body:f}); log("put:",put.status,put.statusText);
    const base="https://pub-f411a341ba7f44a28234293891897c59.r2.dev";
    const link=pj.publicUrl || (pj.key ? base + "/" + encodeURIComponent(pj.key) : null);
    if(!link) throw new Error("no hay link");
    $("result").innerHTML = '<p>✅ <a href="'+link+'" target="_blank" rel="noopener">Abrir archivo</a></p><div class="preview"><img src="'+link+'"/></div>';
    $("status").textContent="listo ✅";
  }catch(e){ log("error:",e.message); $("status").textContent="error ❌"; }
}
</script>
</body></html>
