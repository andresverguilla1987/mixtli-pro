<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pago exitoso</title>
  <link rel="icon" href="assets/logo.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <main class="mx-auto max-w-xl px-4 sm:px-6 lg:px-8 py-16">
    <div class="rounded-2xl border border-white/10 bg-white/5 p-6">
      <h1 class="text-2xl font-extrabold">✅ Pago recibido</h1>
      <p class="text-slate-300 mt-2">Gracias. Aquí está tu comprobante.</p>

      <dl class="mt-4 space-y-2 text-sm">
        <div class="flex justify-between"><dt class="text-slate-400">Proveedor</dt><dd id="prov">-</dd></div>
        <div class="flex justify-between"><dt class="text-slate-400">Referencia</dt><dd id="ref">-</dd></div>
        <div class="flex justify-between"><dt class="text-slate-400">Monto</dt><dd id="amt">-</dd></div>
        <div class="flex justify-between"><dt class="text-slate-400">Moneda</dt><dd id="cur">-</dd></div>
        <div class="flex justify-between"><dt class="text-slate-400">Concepto</dt><dd id="concept">-</dd></div>
        <div class="flex justify-between"><dt class="text-slate-400">Fecha</dt><dd id="date">-</dd></div>
      </dl>

      <div class="mt-6 flex gap-3">
        <a href="dashboard.html" class="px-4 py-2 rounded-md bg-white/10 hover:bg-white/20">Ir al Dashboard</a>
        <button id="pdfBtn" class="px-4 py-2 rounded-md bg-brand-500 hover:bg-brand-600 text-white">Descargar PDF</button>
      </div>
      <div class="mt-4">
        <button id="mailBtn" class="px-4 py-2 rounded-md bg-white/10 hover:bg-white/20">Enviar por email</button>
        <span id="mailMsg" class="text-xs text-slate-400 ml-2"></span>
      </div>
    </div>
  </main>

  <script>
    const qp = new URLSearchParams(location.search);
    const data = {
      provider: qp.get('provider') || 'stripe',
      ref: qp.get('ref') || 'N/A',
      amount: qp.get('amount') || '0.00',
      currency: (qp.get('currency') || 'MXN').toUpperCase(),
      concept: qp.get('concept') || 'Recarga de saldo',
      date: new Date().toLocaleString()
    };
    document.getElementById('prov').textContent = data.provider;
    document.getElementById('ref').textContent = data.ref;
    document.getElementById('amt').textContent = data.amount;
    document.getElementById('cur').textContent = data.currency;
    document.getElementById('concept').textContent = data.concept;
    document.getElementById('date').textContent = data.date;

    document.getElementById('pdfBtn').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text('MIXTLI - Comprobante de Pago', 20, 20);
      doc.setFontSize(12);
      const lines = [
        'Proveedor: ' + data.provider,
        'Referencia: ' + data.ref,
        'Monto: ' + data.amount + ' ' + data.currency,
        'Concepto: ' + data.concept,
        'Fecha: ' + data.date
      ];
      let y = 40;
      lines.forEach(t => { doc.text(t, 20, y); y += 10; });
      doc.save('comprobante-mixtli.pdf');
    });
    document.getElementById("mailBtn").addEventListener("click", async ()=>{
      const to = prompt("¿A qué correo te enviamos el recibo?"); if(!to) return;
      const body = `Proveedor: ${data.provider}\nReferencia: ${data.ref}\nMonto: ${data.amount} ${data.currency}\nConcepto: ${data.concept}\nFecha: ${data.date}`;
      try{
        const r = await fetch("/functions/v1/send-receipt", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ to, subject:"Comprobante Mixtli", text: body }) });
        const j = await r.json();
        document.getElementById("mailMsg").textContent = j.ok? "Enviado ✅" : (j.error||"Error");
      }catch(e){ document.getElementById("mailMsg").textContent = "Error"; }
    });
  </script>
</body>
</html>
