<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mixtli — Uploader v3 (Diagnósticos)</title>
<style>
  :root{--bg:#0b0f14;--panel:#0f1621;--border:#1e2a3a;--text:#e6eef7;--muted:#8aa0b6;--accent:#2b8a3e;--warn:#b45309;--err:#b91c1c;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
  .wrap{max-width:1060px;margin:20px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.28)}
  h1{margin:.2rem 0 1rem} .muted{color:var(--muted)} .tiny{font-size:12px}
  input,select,button,textarea{font:inherit}
  input[type="url"],input[type="text"],select,textarea{width:100%;background:#0b121b;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px}
  textarea{min-height:120px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:9px 12px;cursor:pointer;font-weight:700}
  .btn.ghost{background:#0b121b;border:1px solid var(--border);color:var(--text)}
  .btn.warn{background:var(--warn)}
  .btn.err{background:var(--err)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 820px){ .grid2{grid-template-columns:1fr} }
  .drop{border:2px dashed #2a3a52;padding:24px;border-radius:14px;text-align:center;color:#9eb1c8}
  .drop.drag{background:#0b121b;border-color:#3e5676;color:#cfe2fa}
  .progress{height:12px;background:#0b121b;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:var(--accent);transition:width .15s ease}
  .kv{display:grid;grid-template-columns:220px 1fr;gap:8px;margin-top:6px}
  .box{background:#0b121b;border:1px solid var(--border);border-radius:10px;padding:8px;font-family:ui-monospace,Menlo,monospace;font-size:12px;color:#d1dae4;overflow:auto}
  .logs{white-space:pre-wrap;max-height:260px}
  .preview img{max-width:100%;border-radius:12px;border:1px solid var(--border)}
  .ok{color:#22c55e} .fail{color:#ef4444}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Mixtli — Uploader v3 <span class="tiny muted">con diagnósticos</span></h1>

    <div class="card">
      <h3>Modo de conexión</h3>
      <div class="grid2">
        <div>
          <label>Método</label>
          <select id="mode">
            <option value="proxy" selected>Proxy Netlify (usar /api/* relativo)</option>
            <option value="direct">Directo (API Base personalizada)</option>
          </select>
        </div>
        <div id="baseWrap" style="display:none">
          <label>API Base (solo modo Directo)</label>
          <input id="apiBase" type="url" placeholder="https://mixtli-pro.onrender.com (sin /api)">
        </div>
      </div>
      <div class="row">
        <button class="btn" id="saveCfg">Guardar</button>
        <button class="btn ghost" id="resetCfg">Reset</button>
        <button class="btn ghost" id="testHealth">Probar /health</button>
        <button class="btn ghost" id="testPresign">Probar presign</button>
        <span id="cfgMsg" class="muted tiny"></span>
      </div>
      <div class="kv">
        <div class="muted tiny">Origin actual</div><div class="tiny box" id="infoOrigin"></div>
        <div class="muted tiny">Base efectiva</div><div class="tiny box" id="infoBase"></div>
        <div class="muted tiny">Endpoints usados</div><div class="tiny box" id="infoEndpoints"></div>
      </div>
    </div>

    <div class="card">
      <h3>Subida</h3>
      <div id="drop" class="drop">Arrastra aquí o <label class="btn ghost">elige<input id="file" type="file" hidden></label></div>
      <div class="row">
        <button class="btn" id="btnUpload" disabled>Subir</button>
        <span id="status" class="muted"></span>
      </div>
      <div class="progress" style="margin-top:8px;"><div id="bar" class="bar"></div></div>
      <div class="row tiny muted"><span id="pct">0%</span> · <span id="speed">0 MB/s</span> · <span id="eta">ETA --s</span></div>
    </div>

    <div class="card">
      <h3>Resultado</h3>
      <div class="row">
        <input id="publicUrl" type="text" placeholder="Aquí aparecerá el enlace público..." readonly>
        <button class="btn ghost" id="open" disabled>Abrir</button>
        <button class="btn ghost" id="copy" disabled>Copiar</button>
      </div>
      <div class="preview"><img id="img" style="display:none"></div>
    </div>

    <div class="card">
      <h3>Modo manual (si tu API no responde)</h3>
      <p class="tiny muted">Pega el JSON **real** del presign (url, method, headers, publicUrl...).</p>
      <textarea id="manual" placeholder='{"url":"...","method":"PUT","headers":{"Content-Type":"image/jpeg"},"publicUrl":"...","key":"..."}'></textarea>
      <div class="row">
        <button class="btn warn" id="btnManual">Subir con presign</button>
        <span class="tiny muted">Requiere seleccionar archivo arriba.</span>
      </div>
    </div>

    <div class="card">
      <h3>Diagnósticos</h3>
      <div class="box logs" id="logs"></div>
      <div class="row">
        <button class="btn ghost" id="clearLogs">Limpiar logs</button>
      </div>
    </div>
  </div>

<script>
  const $ = s => document.querySelector(s);
  const logs = $("#logs");
  function log(...a){ try{ logs.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(" ")+"\\n"; logs.scrollTop=logs.scrollHeight; }catch{} console.log(...a); }
  const delay = ms => new Promise(r=>setTimeout(r,ms));

  // --- Config state ---
  const modeSel = $("#mode");
  const baseWrap = $("#baseWrap");
  const apiBaseInput = $("#apiBase");
  const cfgMsg = $("#cfgMsg");
  const infoOrigin = $("#infoOrigin");
  const infoBase = $("#infoBase");
  const infoEndpoints = $("#infoEndpoints");

  function getCfg(){
    const mode = localStorage.getItem("mode") || "proxy";
    const base = localStorage.getItem("api_base") || "";
    return { mode, base };
  }
  function setCfg({mode, base}){
    if(mode) localStorage.setItem("mode", mode);
    if(base !== undefined) localStorage.setItem("api_base", base.trim());
    cfgMsg.textContent = "Guardado";
    setTimeout(()=>cfgMsg.textContent="",1200);
    applyCfg();
  }
  function applyCfg(){
    const {mode, base} = getCfg();
    modeSel.value = mode;
    baseWrap.style.display = (mode === "direct" ? "block" : "none");
    apiBaseInput.value = base;
    const origin = location.origin;
    const effectiveBase = (mode === "proxy") ? "" : (base.replace(/\\/$/,""));
    infoOrigin.textContent = origin;
    infoBase.textContent = (mode === "proxy") ? "(proxy) relativo: "+origin+"/api/*" : effectiveBase || "(no puesto)";
    infoEndpoints.textContent = (mode === "proxy")
      ? "/api/health, /api/presign"
      : (effectiveBase || "(no puesto)") + "/api/health , " + (effectiveBase || "(no puesto)") + "/api/presign";
  }

  modeSel.onchange = ()=> applyCfg();
  $("#saveCfg").onclick = ()=> setCfg({ mode: modeSel.value, base: apiBaseInput.value });
  $("#resetCfg").onclick = ()=> { localStorage.removeItem("mode"); localStorage.removeItem("api_base"); applyCfg(); };

  applyCfg();
  infoOrigin.textContent = location.origin;

  // --- Helpers ---
  function baseUrl(){
    const {mode, base} = getCfg();
    if(mode === "proxy") return ""; // relative
    return (base || "").replace(/\\/$/, "");
  }
  function urlHealth(){ return baseUrl() + "/api/health"; }
  function urlPresignGET(filename, ct){ return baseUrl() + `/api/presign?filename=${encodeURIComponent(filename)}&contentType=${encodeURIComponent(ct)}`; }
  function urlPresignPOST(){ return baseUrl() + "/api/presign"; }

  async function fetchText(url, opts={}, timeoutMs=10000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort("timeout"), timeoutMs);
    try{
      const r = await fetch(url, { signal: ctrl.signal, ...opts });
      const txt = await r.text();
      return { ok: r.ok, status: r.status, text: txt, headers: r.headers };
    }catch(e){
      return { ok:false, status:0, text:String(e) };
    }finally{
      clearTimeout(t);
    }
  }

  $("#testHealth").onclick = async ()=>{
    const url = urlHealth();
    log("GET", url);
    const r = await fetchText(url);
    log("health:", r.status, r.text.slice(0,400));
    cfgMsg.textContent = "Health " + r.status + (r.ok ? " ✓" : " ✗");
  };

  $("#testPresign").onclick = async ()=>{
    const url = urlPresignGET("ping.txt","text/plain");
    log("GET", url);
    const r = await fetchText(url);
    log("presign:", r.status, r.text.slice(0,400));
    cfgMsg.textContent = "Presign " + r.status + (r.ok ? " ✓" : " ✗");
  };

  // --- Upload ---
  const drop = $("#drop");
  const fileEl = $("#file");
  const btnUpload = $("#btnUpload");
  const statusEl = $("#status");
  const bar = $("#bar");
  const pct = $("#pct");
  const speed = $("#speed");
  const eta = $("#eta");
  const publicUrl = $("#publicUrl");
  const openBtn = $("#open");
  const copyBtn = $("#copy");
  const img = $("#img");

  let file = null;
  function gotFile(f){
    file = f;
    btnUpload.disabled = !file;
    statusEl.textContent = file ? `Archivo: ${file.name} (${Math.ceil(file.size/1024)} KB)` : "";
  }
  fileEl.onchange = e => { if(e.target.files && e.target.files[0]) gotFile(e.target.files[0]); };
  ["dragenter","dragover"].forEach(evt => drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add("drag"); }));
  ["dragleave","drop"].forEach(evt => drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove("drag"); }));
  drop.addEventListener("drop", e => { const f=e.dataTransfer.files&&e.dataTransfer.files[0]; if(f) gotFile(f); });

  function setResult(url){
    publicUrl.value = url || "";
    const isImg = url && /\.(png|jpg|jpeg|gif|webp|avif)$/i.test(url);
    img.style.display = isImg ? "block" : "none";
    if(isImg){ img.src = url + (url.includes("?")?"&":"?") + "t=" + Date.now(); }
    openBtn.disabled = !url; copyBtn.disabled = !url;
  }
  openBtn.onclick = ()=>{ if(publicUrl.value) window.open(publicUrl.value, "_blank"); };
  copyBtn.onclick = async ()=>{ if(publicUrl.value) try{ await navigator.clipboard.writeText(publicUrl.value); }catch{} };

  function putWithProgress(presign, file){
    return new Promise((resolve,reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open(presign.method || "PUT", presign.url, true);
      const headers = presign.headers || {};
      Object.keys(headers).forEach(k => { try{ xhr.setRequestHeader(k, headers[k]); }catch{} });
      const start = Date.now();
      xhr.upload.onprogress = (e)=>{
        if(e.lengthComputable){
          const p = Math.round((e.loaded/e.total)*100);
          bar.style.width = p + "%";
          pct.textContent = p + "%";
          const secs = (Date.now()-start)/1000;
          const sp = secs>0 ? (e.loaded/1024/1024)/secs : 0;
          speed.textContent = sp.toFixed(2) + " MB/s";
          const rem = e.total - e.loaded;
          const etaS = sp>0 ? (rem/1024/1024)/sp : 0;
          eta.textContent = "ETA " + (etaS>60 ? Math.round(etaS/60)+"m" : Math.round(etaS)+"s");
        }
      };
      xhr.onload = ()=>{
        const ok = xhr.status>=200 && xhr.status<300;
        ok ? resolve() : reject(new Error("PUT "+xhr.status));
      };
      xhr.onerror = ()=> reject(new Error("Network/CORS PUT"));
      xhr.send(file);
    });
  }

  async function getPresignAuto(filename, contentType){
    const getURL = urlPresignGET(filename, contentType);
    log("GET", getURL);
    try{
      const r1 = await fetch(getURL, { method:"GET" });
      if(r1.ok){ const j = await r1.json(); return j; }
      log("GET presign status", r1.status);
    }catch(e){
      log("GET presign error", String(e));
    }
    const postURL = urlPresignPOST();
    log("POST", postURL);
    const r2 = await fetch(postURL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ filename, contentType })
    });
    if(!r2.ok){
      const t = await r2.text();
      log("POST presign body", t);
      throw new Error("presign "+r2.status);
    }
    return await r2.json();
  }

  $("#btnUpload").onclick = async ()=>{
    if(!file){ alert("Selecciona un archivo"); return; }
    bar.style.width="0%"; pct.textContent="0%"; speed.textContent="0 MB/s"; eta.textContent="ETA --s";
    statusEl.textContent = "Generando presign…";
    try{
      const presign = await getPresignAuto(file.name, file.type || "application/octet-stream");
      if(!presign || !presign.url) throw new Error("presign inválido");
      statusEl.textContent = "Subiendo…";
      await putWithProgress(presign, file);
      statusEl.textContent = "Subida completa ✓";
      const url = presign.publicUrl || (presign.publicBase && presign.key ? presign.publicBase.replace(/\/$/,"") + "/" + presign.key : "");
      setResult(url);
      log("publicUrl:", url || "(no provisto)");
    }catch(err){
      statusEl.textContent = "Error: " + (err.message || String(err));
      log("upload error:", err.message || String(err));
      alert("Falló presign/PUT: " + (err.message || String(err)) + "\nRevisa pestaña Diagnósticos y prueba los botones de Health/Presign.");
    }
  };

  // Manual
  function parseJsonLoose(s){
    let t = (s||"").trim();
    t = t.replace(/[“”]/g,'"').replace(/[‘’]/g,"'");
    const singles = (t.match(/'/g)||[]).length, doubles=(t.match(/"/g)||[]).length;
    if(singles > doubles) t = t.replace(/'/g,'"');
    t = t.replace(/,\s*([}\]])/g,"$1");
    return JSON.parse(t);
  }
  $("#btnManual").onclick = async ()=>{
    if(!file){ alert("Selecciona un archivo arriba"); return; }
    try{
      const p = parseJsonLoose($("#manual").value);
      if(!p || !p.url || !p.method) throw new Error("JSON sin url/method");
      bar.style.width="0%"; pct.textContent="0%"; speed.textContent="0 MB/s"; eta.textContent="ETA --s";
      statusEl.textContent = "Subiendo (manual)…";
      await putWithProgress(p, file);
      statusEl.textContent = "Subida completa ✓ (manual)";
      setResult(p.publicUrl || "");
    }catch(e){
      log("manual parse/error:", e);
      alert("Manual falló: " + e.message + "\nPega el JSON completo de tu presign.");
    }
  };

  // Logs
  $("#clearLogs").onclick = ()=>{ logs.textContent=""; };

  // Initial log
  log("origin:", location.origin);
</script>
</body>
</html>