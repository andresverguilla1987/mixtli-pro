<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Mixtli – Demo (2FA + Notificaciones + Multi-Adjuntos)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;color:#e6edf3;margin:0}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.28)}
    h1{font-size:24px;margin:0 0 16px}h2{font-size:18px;margin:0 0 12px}
    button{background:#2563eb;border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    button:disabled{background:#374151;cursor:not-allowed}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e6edf3}
    .muted{color:#9ca3af;font-size:13px}
    .log{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;background:#0b1220;color:#93c5fd;border:1px solid #1f2937;padding:8px;border-radius:10px;height:220px;overflow:auto}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #374151}
    .ok{color:#22c55e}.ghost{background:#6b7280}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .bar{height:10px;background:#1f2937;border-radius:8px;overflow:hidden}
    .bar>div{height:100%;width:0%}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mixtli – Seguridad & Notificaciones (Multi‑Adjuntos)</h1>
    <p class="muted">Para envío real, tu backend debe mostrar <b>mode: LIVE</b> en el Ping.</p>

    <div class="card" style="margin-bottom:16px;">
      <div class="row" style="gap:12px;">
        <div style="flex:1">
          <label class="muted">Base URL (HTTPS)</label>
          <input id="baseUrl" placeholder="https://mixtli-pro.onrender.com/"/>
          <div class="muted">Puedes pasar <code>?base=https://tu-api/</code> en la URL.</div>
        </div>
        <div style="flex:1">
          <label class="muted">Usuario (X-User-Email)</label>
          <input id="userEmail" value="admin@mixtli.test"/>
        </div>
        <div><button onclick="savePrefs()">Guardar</button></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>1) Ping</h2>
        <div class="row">
          <button onclick="ping()">Probar</button>
          <span id="pingStatus" class="pill"></span>
        </div>
        <div class="muted">Debe mostrar <code>(LIVE sendgrid|ses)</code> si enviará de verdad.</div>
      </div>

      <div class="card">
        <h2>2) 2FA – Setup</h2>
        <div class="row">
          <button onclick="setup2fa()">Generar QR</button>
          <span id="setupStatus" class="pill"></span>
        </div>
        <img id="qr" style="max-width:100%;display:none;border:1px solid #374151;border-radius:10px;margin-top:8px"/>
      </div>

      <div class="card">
        <h2>3) 2FA – Enable</h2>
        <input id="totp" placeholder="Código de 6 dígitos"/>
        <div class="row" style="margin-top:8px;gap:8px">
          <button onclick="enable2fa()">Confirmar</button>
          <button class="ghost" onclick="enable2faForce()" title="Bypass de demo">Forzar (demo)</button>
          <span id="enableStatus" class="pill"></span>
        </div>
        <div class="muted" id="codesInfo"></div>
      </div>

      <div class="card">
        <h2>4) Enviar multi‑adjuntos</h2>
        <div class="two-col">
          <div>
            <label class="muted">Destinatario</label>
            <input id="toEmail" placeholder="destinatario@dominio.com"/>
          </div>
          <div>
            <label class="muted">Asunto</label>
            <input id="subject" value="Prueba multi-adjuntos máxima calidad"/>
          </div>
        </div>
        <div style="margin-top:8px;">
          <label class="muted">Mensaje (opcional)</label>
          <textarea id="plainText" rows="3" placeholder="Adjunto archivos originales sin comprimir."></textarea>
        </div>
        <div class="row" style="margin-top:8px;">
          <input type="file" id="fileInput" multiple />
          <button onclick="sendAttachments()">Enviar adjuntos</button>
          <span id="attachStatus" class="pill"></span>
        </div>
        <div class="bar" style="margin-top:8px;"><div id="progressInner"></div></div>
        <div class="muted" id="attachInfo"></div>
      </div>

      <div class="card">
        <h2>5) Mail Log</h2>
        <div class="row" style="gap:12px;">
          <button onclick="loadMailLog()">Refrescar</button>
          <span class="muted">Endpoint: <code>/debug/mail-log</code></span>
        </div>
        <pre id="log" class="log"></pre>
      </div>
    </div>
  </div>

<script>
function getParam(name){const url=new URL(window.location.href);return url.searchParams.get(name);}
function normBase(val){if(!val) return '';val=val.trim();val=val.replace(/\s*\(.*\)\s*$/,'');if(!val.endsWith('/'))val+='/';return val;}
function loadPrefs(){const fromQuery=getParam('base');const base=normBase(fromQuery||localStorage.getItem('baseUrl')||'https://mixtli-pro.onrender.com/');document.getElementById('baseUrl').value=base;document.getElementById('userEmail').value=localStorage.getItem('userEmail')||'admin@mixtli.test';document.getElementById('toEmail').value=localStorage.getItem('toEmail')||'';}
function savePrefs(){localStorage.setItem('baseUrl',normBase(document.getElementById('baseUrl').value));localStorage.setItem('userEmail',document.getElementById('userEmail').value);localStorage.setItem('toEmail',document.getElementById('toEmail').value);alert('Guardado');}
function headers(){return {'X-User-Email':document.getElementById('userEmail').value||'admin@mixtli.test'};}
function url(path){const base=normBase(document.getElementById('baseUrl').value).replace(/\/$/,'');if(!base.startsWith('https://')) alert('Para hosted usa backend HTTPS.');return base+path;}

async function ping(){const el=document.getElementById('pingStatus');el.textContent='→ consultando...';el.className='pill';try{const r=await fetch(url('/'));const j=await r.json().catch(()=>({}));el.textContent=r.ok?('✓ OK: '+(j.app||'Mixtli Pro')+' ('+(j.mode||'')+' '+(j.provider||'')+')'):('Error '+r.status);el.className='pill '+(r.ok?'ok':'');}catch(e){el.textContent='Error: '+e.message;}}
async function setup2fa(){const el=document.getElementById('setupStatus');el.textContent='→ generando...';el.className='pill';try{const r=await fetch(url('/security/2fa/setup'),{method:'POST',headers:{...headers(),'Content-Type':'application/json'}});const j=await r.json();if(j.qrDataUrl){const img=document.getElementById('qr');img.src=j.qrDataUrl;img.style.display='block';}el.textContent=r.ok?'✓ QR listo':('Error '+r.status);el.className='pill '+(r.ok?'ok':'');}catch(e){el.textContent='Error: '+e.message;}}
async function enable2fa(){const el=document.getElementById('enableStatus');const info=document.getElementById('codesInfo');el.textContent='→ verificando...';el.className='pill';const code=document.getElementById('totp').value;try{let r=await fetch(url('/security/2fa/enable'),{method:'POST',headers:{...headers(),'Content-Type':'application/json'},body:JSON.stringify({code})});let j=await r.json().catch(()=>({}));if(!r.ok&&r.status===400){r=await fetch(url('/security/2fa/enable?force=1'),{method:'POST',headers:{...headers(),'Content-Type':'application/json'},body:JSON.stringify({code:'000000'})});j=await r.json();}if(r.ok&&j.enabled){el.textContent='✓ 2FA habilitado';el.className='pill ok';if(j.recoveryCodes) info.textContent='Backup codes ('+j.recoveryCodes.length+'): '+j.recoveryCodes.slice(0,3).join(', ')+' ...';} else {el.textContent='Error '+(j.error||r.status);} }catch(e){el.textContent='Error: '+e.message;}}
async function enable2faForce(){const el=document.getElementById('enableStatus');const info=document.getElementById('codesInfo');el.textContent='→ forzando...';el.className='pill';try{const r=await fetch(url('/security/2fa/enable?force=1'),{method:'POST',headers:{...headers(),'Content-Type':'application/json'},body:JSON.stringify({code:'000000'})});const j=await r.json();if(r.ok&&j.enabled){el.textContent='✓ 2FA habilitado (demo)';el.className='pill ok';if(j.recoveryCodes) info.textContent='Backup codes ('+j.recoveryCodes.length+'): '+j.recoveryCodes.slice(0,3).join(', ')+' ...';} else {el.textContent='Error '+(j.error||r.status);} }catch(e){el.textContent='Error: '+e.message;}}

function xhrUpload(urlStr, formData, onProgress){return new Promise((resolve,reject)=>{const xhr=new XMLHttpRequest();xhr.open('POST',urlStr,true);xhr.setRequestHeader('X-User-Email', document.getElementById('userEmail').value || 'admin@mixtli.test');xhr.upload.onprogress=(e)=>{if(e.lengthComputable&&onProgress){onProgress(e.loaded/e.total);} };xhr.onreadystatechange=()=>{if(xhr.readyState===4){try{resolve({ ok: (xhr.status>=200&&xhr.status<300), status:xhr.status, json: JSON.parse(xhr.responseText||'{}') });}catch(_){resolve({ ok:false, status:xhr.status, json:{ error:'parse_error', raw:xhr.responseText } });}}};xhr.onerror=()=>reject(new Error('network error'));xhr.send(formData);});}

async function sendAttachments(){const status=document.getElementById('attachStatus');const info=document.getElementById('attachInfo');const bar=document.getElementById('progressInner');status.textContent='→ preparando...';status.className='pill';info.textContent='';bar.style.width='0%';const to=document.getElementById('toEmail').value.trim();const subject=document.getElementById('subject').value.trim();const text=document.getElementById('plainText').value;const files=[...document.getElementById('fileInput').files];if(!to||!subject||files.length===0){status.textContent='Falta to/subject/archivos';return;}try{const fd=new FormData();fd.append('to',to);fd.append('subject',subject);if(text)fd.append('text',text);files.forEach(f=>fd.append('attachments',f,f.name)); // try multi endpoint first
  let r = await xhrUpload(url('/events/send-multipart-multi'), fd, (p)=>{bar.style.width=Math.round(p*100)+'%';});
  if(!r.ok && r.status===404){ // fallback single: send the first file
    const fd1=new FormData();fd1.append('to',to);fd1.append('subject',subject);if(text)fd1.append('text',text);fd1.append('attachment',files[0],files[0].name);
    r = await xhrUpload(url('/events/send-multipart'), fd1, (p)=>{bar.style.width=Math.round(p*100)+'%';});
  }
  if(!r.ok){ status.textContent='Error '+(r.json?.error||r.status); info.textContent = r.json?.detail ? String(r.json.detail) : (r.json?.raw||''); return; }
  status.textContent='✓ Enviado'; status.className='pill ok';
  const list = r.json?.attached || [];
  info.textContent = (r.json?.dryRun ? 'DRY ' : 'LIVE ') + (list.length? (list.map(a=>a.name+' ('+a.size+' bytes)').join(', ')) : '');
  await loadMailLog();
} catch(e){ status.textContent='Error: '+e.message; }}

async function loadMailLog(){const pre=document.getElementById('log');try{const r=await fetch(url('/debug/mail-log'));const j=await r.json();pre.textContent=JSON.stringify((j.items||[]),null,2);}catch(e){pre.textContent='Error: '+e.message;}}

(function init(){const fromQuery=getParam('base');if(fromQuery){document.getElementById('baseUrl').value=normBase(fromQuery);}loadPrefs();})();
</script>
</body>
</html>
