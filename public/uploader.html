<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Mixtli Uploader (Multipart)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; max-width: 720px; margin: 0 auto; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 16px; }
      .row { display:flex; gap:12px; align-items:center; }
      .row > * { flex:1; }
      progress { width: 100%; height: 16px; }
      button { padding: 10px 14px; border-radius: 10px; border: 1px solid #999; background: #111; color: #fff; cursor:pointer; }
      input[type=file] { padding: 8px; }
      code { background: #f6f8fa; padding: 2px 6px; border-radius: 6px; }
      .muted { color: #666; }
    </style>
  </head>
  <body>
    <h1>Mixtli â€” Upload multipart</h1>
    <p class="muted">Sube archivos grandes directo a S3/R2/MinIO mediante URLs firmadas.</p>

    <div class="card">
      <div class="row">
        <input type="file" id="file" />
        <button id="btn">Subir</button>
      </div>
      <div class="row">
        <progress id="pg" value="0" max="100"></progress>
      </div>
      <pre id="log"></pre>
    </div>

<script>
const baseUrl = location.origin;
const logEl = document.getElementById('log');
function log(...args){ logEl.textContent += args.join(' ') + '\\n'; }

async function subir() {
  const file = document.getElementById('file').files[0];
  if (!file) { alert('Selecciona un archivo'); return; }

  let r = await fetch(baseUrl + '/api/uploads/multipart/init', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ filename: file.name, contentType: file.type || 'application/octet-stream', size: file.size })
  });
  if (!r.ok) { log('init error:', await r.text()); return; }
  const init = await r.json();
  log('INIT ok', JSON.stringify(init));

  const partSize = init.partSize || (5*1024*1024);
  const totalParts = Math.ceil(file.size / partSize);
  const etags = [];

  for (let partNumber = 1; partNumber <= totalParts; partNumber++) {
    const start = (partNumber - 1) * partSize;
    const end = Math.min(start + partSize, file.size);
    const blob = file.slice(start, end);

    let s = await fetch(baseUrl + '/api/uploads/multipart/sign-part?' + new URLSearchParams({
      key: init.key, uploadId: init.uploadId, partNumber
    }));
    if (!s.ok) { log('sign error:', await s.text()); return; }
    const { url } = await s.json();

    const put = await fetch(url, { method: 'PUT', body: blob });
    if (!put.ok) { log('put part error:', await put.text()); return; }
    const etag = put.headers.get('ETag');
    etags.push({ ETag: etag, PartNumber: partNumber });
    document.getElementById('pg').value = Math.round(partNumber * 100 / totalParts);
  }

  let c = await fetch(baseUrl + '/api/uploads/multipart/complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ key: init.key, uploadId: init.uploadId, parts: etags })
  });
  if (!c.ok) { log('complete error:', await c.text()); return; }
  const done = await c.json();
  log('COMPLETE ok', JSON.stringify(done));
  alert('Subida completa: ' + (done.location || done.key));
}

document.getElementById('btn').addEventListener('click', subir);
</script>
  </body>
</html>
