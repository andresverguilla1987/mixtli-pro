<!-- public/files.html -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mixtli — Archivos del bucket</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e8eef6; margin:0; }
    header { padding:28px 24px 8px; }
    h1 { margin:0 0 6px; font-size:36px; }
    nav { padding:0 24px 16px; }
    nav a { color:#9cc2ff; text-decoration:none; margin-right:16px; }
    .card { background:#0f1620; margin:24px; border:1px solid #1b2a3a; border-radius:14px; overflow:hidden; }
    .toolbar { display:flex; gap:12px; align-items:center; padding:16px; border-bottom:1px solid #1b2a3a; }
    input[type=text]{ flex:1; background:#0b1220; color:#e8eef6; border:1px solid #243448; border-radius:10px; padding:12px }
    button { background:#101820; color:#fff; border:1px solid #243448; border-radius:10px; padding:10px 18px; cursor:pointer; }
    button:hover{ background:#122231; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:12px 16px; border-bottom:1px solid #162334; }
    th { color:#9fb8d6; font-weight:600; text-align:left; }
    .actions a{ color:#8fd1ff; margin-right:12px; text-decoration:none }
    .empty { padding:24px; color:#89a; }
  </style>
</head>
<body>
  <header><h1>Mixtli — Archivos del bucket</h1></header>
  <nav>
    <a href="/uploader.html">Uploader</a>
    <strong>Archivos</strong>
  </nav>
  <section class="card">
    <div class="toolbar">
      <label>Prefijo</label>
      <input type="text" id="prefix" value="uploads/" />
      <button id="btn">Actualizar</button>
    </div>
    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr><th>Archivo (key)</th><th>Tamaño</th><th>Modificado</th><th>Acciones</th></tr>
        </thead>
        <tbody id="rows"><tr><td colspan="4" class="empty">Sin resultados…</td></tr></tbody>
      </table>
    </div>
  </section>

  <script>
    async function load() {
      const prefix = document.getElementById('prefix').value.trim();
      const res = await fetch(`/api/uploads/list?prefix=${encodeURIComponent(prefix)}`);
      const data = await res.json();
      const rows = document.getElementById('rows');
      rows.innerHTML = '';
      const files = (data.archivos || []).filter(x => !!x.key);
      if (!files.length) {
        rows.innerHTML = '<tr><td colspan="4" class="empty">Sin resultados…</td></tr>';
        return;
      }
      for (const f of files) {
        const tr = document.createElement('tr');
        const size = (f.size || 0);
        const nice = size > 1e9 ? (size/1e9).toFixed(2)+' GB'
                  : size > 1e6 ? (size/1e6).toFixed(2)+' MB'
                  : size > 1e3 ? (size/1e3).toFixed(2)+' KB'
                  : size + ' B';
        const fecha = f.lastModified ? new Date(f.lastModified).toLocaleString() : '';
        tr.innerHTML = `
          <td>${f.key}</td>
          <td>${nice}</td>
          <td>${fecha}</td>
          <td class="actions">
            <a href="#" data-key="${f.key}" class="dl">Descargar</a>
          </td>`;
        rows.appendChild(tr);
      }
      // enlaces de descarga firmada
      rows.querySelectorAll('a.dl').forEach(a => {
        a.addEventListener('click', async (e) => {
          e.preventDefault();
          const key = a.getAttribute('data-key');
          const r = await fetch(`/api/uploads/sign-get?key=${encodeURIComponent(key)}`);
          const j = await r.json();
          if (j.url) window.open(j.url, '_blank');
          else alert('No se pudo firmar URL');
        });
      });
    }
    document.getElementById('btn').addEventListener('click', load);
    load();
  </script>
</body>
</html>