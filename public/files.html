<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mixtli — Archivos del bucket</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; border-bottom: 1px solid #333; }
    a.button { padding: 0.3rem 0.6rem; background: #444; color: #fff; text-decoration: none; border-radius: 4px; }
    a.button:hover { background: #666; }
  </style>
</head>
<body>
  <h1>Mixtli — Archivos del bucket</h1>
  <input id="prefix" value="uploads/" placeholder="Prefijo"/>
  <button onclick="loadFiles()">Actualizar</button>
  <p id="summary"></p>
  <table>
    <thead>
      <tr><th>Archivo (key)</th><th>Tamaño</th><th>Modificado</th><th>Acciones</th></tr>
    </thead>
    <tbody id="files"></tbody>
  </table>

<script>
async function loadFiles() {
  const prefix = document.getElementById("prefix").value;
  const res = await fetch(`/api/files?prefix=${encodeURIComponent(prefix)}`);
  const data = await res.json();
  const tbody = document.getElementById("files");
  tbody.innerHTML = "";
  let total = 0;
  data.forEach(file => {
    total += file.size;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${file.key}</td>
      <td>${(file.size/1024).toFixed(2)} KB</td>
      <td>${new Date(file.lastModified).toLocaleString()}</td>
      <td>
        <a href="#" class="button" onclick="downloadFile('${file.key}')">Descargar</a>
        <a href="#" class="button" onclick="deleteFile('${file.key}')">Borrar</a>
      </td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById("summary").innerText = data.length + " archivos, " + (total/1024/1024).toFixed(2) + " MB";
}

async function downloadFile(key) {
  const res = await fetch(`/api/files/download-url?key=${encodeURIComponent(key)}`);
  const data = await res.json();
  window.open(data.url, "_blank");
}

async function deleteFile(key) {
  if (!confirm("¿Borrar " + key + "?")) return;
  await fetch(`/api/files?key=${encodeURIComponent(key)}`, { method: "DELETE" });
  loadFiles();
}

loadFiles();
</script>
</body>
</html>