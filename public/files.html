
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mixtli â€” Archivos del bucket</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0f14;--card:#121824;--text:#e6edf3;--muted:#9fb0c3;--acc:#59d185;--danger:#ff6b6b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:clamp(28px,4vw,42px);margin:0 0 8px}
    .tabs{display:flex;gap:18px;margin:8px 0 24px}
    .tabs a{color:var(--muted);text-decoration:none;font-weight:600}
    .tabs a.active{color:var(--text)}
    .panel{background:var(--card);border:1px solid #1f2937;border-radius:14px;overflow:hidden}
    .toolbar{display:flex;gap:12px;padding:14px;border-bottom:1px solid #1f2937;align-items:center}
    .toolbar input{flex:1;background:#0d121a;border:1px solid #243347;border-radius:10px;padding:12px 14px;color:var(--text);outline:none}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn{background:#1f2937;color:var(--text)}
    .btn:hover{filter:brightness(1.1)}
    .btn-danger{background:var(--danger);color:#000}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 16px;border-bottom:1px solid #1f2937;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    .row:hover{background:#0f1520}
    .preview{display:flex;align-items:center;gap:12px}
    img.thumb{width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid #243347}
    video.thumb{width:64px;height:40px;border-radius:6px;border:1px solid #243347;background:#000}
    .summary{display:flex;gap:18px;align-items:center;margin:10px 0 20px;color:var(--muted)}
    .pill{background:#0d121a;border:1px solid #243347;border-radius:999px;padding:8px 12px}
    .link{color:var(--acc);text-decoration:none}
    .empty{color:var(--muted);padding:20px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mixtli â€” Archivos del bucket</h1>
    <div class="tabs">
      <a href="/uploader.html">Uploader</a>
      <a class="active" href="/files.html">Archivos</a>
    </div>

    <div class="summary" id="summary">
      <span class="pill" id="count">0 archivos</span>
      <span class="pill" id="total">0 MB</span>
    </div>

    <div class="panel">
      <div class="toolbar">
        <input id="prefix" value="uploads/" placeholder="Prefijo, ej: uploads/">
        <button class="btn" id="refresh">Actualizar</button>
      </div>
      <div class="table">
        <table>
          <thead>
            <tr>
              <th>Archivo (key)</th>
              <th>TamaÃ±o</th>
              <th>Modificado</th>
              <th style="width:160px">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td class="empty" colspan="4">â€”</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);

    function human(n){
      if(n == null) return "-";
      const kb = n/1024, mb = kb/1024, gb = mb/1024;
      if (gb >= 1) return gb.toFixed(2) + " GB";
      if (mb >= 1) return mb.toFixed(2) + " MB";
      return kb.toFixed(2) + " KB";
    }
    function fmtDate(s){
      try{ return new Date(s).toLocaleString(); } catch{ return "-"; }
    }
    function isImg(key){
      return /\.(png|jpg|jpeg|gif|webp|bmp)$/i.test(key);
    }
    function isVideo(key){
      return /\.(mp4|webm|mov|m4v)$/i.test(key);
    }

    async function fetchList(){
      const prefix = encodeURIComponent($("#prefix").value.trim() || "uploads/");
      const res = await fetch(`/api/files?prefix=${prefix}`);
      if(!res.ok){ alert("Error listando archivos"); return; }
      const data = await res.json();
      renderRows(data.items || []);
    }

    function renderRows(items){
      const tb = $("#tbody");
      tb.innerHTML = "";
      if(!items.length){
        tb.innerHTML = `<tr><td class="empty" colspan="4">Sin archivos</td></tr>`;
      }
      let total = 0;
      for(const it of items){
        total += it.size || 0;
        const key = it.key;
        const safeKey = encodeURIComponent(key);
        const row = document.createElement("tr");
        row.className = "row";
        const preview = (()=>{
          if (isImg(key)) {
            // Enlaces de descarga presuntos vÃ­a S3 pÃºblica del bucket si aplica; si no, mostramos solo key.
            return `<div class="preview"><img class="thumb" src="https://${location.host}/api/files/proxy/${safeKey}" onerror="this.src='';this.outerHTML='<span>'+key+'</span>'"><div>${key}</div></div>`;
          } else if (isVideo(key)) {
            return `<div class="preview"><video class="thumb" controls src="https://${location.host}/api/files/proxy/${safeKey}"></video><div>${key}</div></div>`;
          } else {
            return `<div class="preview"><div>ðŸ“„</div><div>${key}</div></div>`;
          }
        })();
        row.innerHTML = `
          <td>${preview}</td>
          <td>${human(it.size)}</td>
          <td>${fmtDate(it.lastModified)}</td>
          <td>
            <a class="link" href="https://${location.host}/api/files/proxy/${safeKey}" target="_blank">Ver</a>
            &nbsp;Â·&nbsp;
            <a class="link" href="https://${location.host}/api/files/download/${safeKey}">Descargar</a>
            &nbsp;Â·&nbsp;
            <button class="btn-danger" data-del="${safeKey}">Eliminar</button>
          </td>
        `;
        tb.appendChild(row);
      }
      // Totales
      $("#count").textContent = `${items.length} archivo${items.length===1?"":"s"}`;
      $("#total").textContent = human(total);
      // Wire delete
      tb.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          const key = btn.getAttribute("data-del");
          const nice = decodeURIComponent(key);
          if(!confirm(`Â¿Eliminar "${nice}"? Esta acciÃ³n no se puede deshacer.`)) return;
          const res = await fetch(`/api/files/${key}`, { method:"DELETE" });
          if(!res.ok){ alert("No se pudo eliminar."); return; }
          await fetchList();
        });
      });
    }

    $("#refresh").addEventListener("click", fetchList);
    $("#prefix").addEventListener("keydown", (e)=>{
      if(e.key === "Enter") fetchList();
    });
    fetchList();
  </script>
</body>
</html>
