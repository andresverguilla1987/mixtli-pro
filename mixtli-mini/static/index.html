<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mixtli — Subir/Compartir</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0d10; color:#e6edf3; }
    header { padding:24px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #1f2630; }
    .logo { font-weight:800; letter-spacing:.5px; }
    .container { max-width:880px; margin:0 auto; padding:24px; }
    .card { background:#0f141a; border:1px solid #1f2630; border-radius:16px; padding:24px; box-shadow:0 10px 24px rgba(0,0,0,.25); }
    .tabs { display:flex; gap:8px; margin-bottom:16px; }
    .tab { padding:8px 12px; border-radius:12px; border:1px solid #243040; background:#111821; opacity:.7; user-select:none; }
    .tab.active { opacity:1; border-color:#2f68ff; }
    .drop { border:2px dashed #2a3647; border-radius:16px; padding:24px; text-align:center; background:#0c1117; }
    .btn { display:inline-block; padding:10px 16px; background:#2f68ff; color:white; border-radius:12px; font-weight:600; border:0; cursor:pointer; }
    .muted { color:#9fb0c3; font-size:14px; }
    .row { display:flex; gap:12px; align-items:center; justify-content:center; }
    input[type="file"] { display:none; }
    .out { margin-top:18px; padding:12px; background:#0c1117; border:1px solid #1f2630; border-radius:12px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small { font-size:12px; color:#8aa0b7 }
  </style>
</head>
<body>
  <header>
    <div class="logo">Mixtli</div>
    <div class="small">Design Lock v1</div>
  </header>
  <div class="container">
    <div class="card">
      <div class="tabs">
        <div class="tab active">Subir / Compartir</div>
      </div>
      <div class="drop" id="drop">
        <p><strong>Arrastra tu archivo</strong> o</p>
        <div class="row">
          <label class="btn" for="file">Elegir archivo</label>
          <input id="file" type="file" />
        </div>
        <p class="muted">Se generará un enlace presignado y se subirá directo a R2.</p>
      </div>
      <div class="out" id="out"></div>
    </div>
  </div>

  <script>
    const API_BASE = window.API_BASE || "%API_BASE%"; // reemplaza en Netlify con tu URL de Render

    const out = document.getElementById('out');
    const fileInput = document.getElementById('file');
    const drop = document.getElementById('drop');

    function log(msg) {
      out.innerHTML += `<div>${msg}</div>`;
    }

    async function presign(name, type) {
      const r = await fetch(API_BASE + '/api/presign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: name, contentType: type })
      });
      if (!r.ok) throw new Error('presign ' + r.status);
      return r.json();
    }

    async function putToR2(url, file) {
      const r = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': file.type || 'application/octet-stream' },
        body: file
      });
      if (!r.ok) throw new Error('put ' + r.status);
      return true;
    }

    async function complete(key) {
      const r = await fetch(API_BASE + '/api/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key })
      });
      if (!r.ok) throw new Error('complete ' + r.status);
      return r.json();
    }

    async function handleFile(file) {
      out.innerHTML = '';
      try {
        log('• Preparando URL presignada…');
        const { url, key } = await presign(file.name, file.type);
        log('✓ Presign listo');
        log('<code>' + key + '</code>');
        log('• Subiendo a R2…');
        await putToR2(url, file);
        log('✓ Subida correcta');
        const fin = await complete(key);
        log('✓ Completo: ' + JSON.stringify(fin));
      } catch (e) {
        log('<span style="color:#ff6b6b">✗ Error: ' + e.message + '</span>');
        console.error(e);
      }
    }

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (f) handleFile(f);
    });

    drop.addEventListener('dragover', (e) => {
      e.preventDefault();
      drop.style.borderColor = '#2f68ff';
    });
    drop.addEventListener('dragleave', () => { drop.style.borderColor = '#2a3647'; });
    drop.addEventListener('drop', (e) => {
      e.preventDefault();
      drop.style.borderColor = '#2a3647';
      const f = e.dataTransfer?.files?.[0];
      if (f) handleFile(f);
    });
  </script>
</body>
</html>
