<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mixtli — Test de Subida (Corrector)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{color-scheme:dark}
  body{margin:0;background:#0a0f1a;color:#e6edf7;font-family:Inter,system-ui}
  .wrap{max-width:900px;margin:0 auto;padding:20px}
  .btn{background:#2563eb;color:#fff;border:0;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
  input{width:100%;background:#0b1220;border:1px solid #223047;color:#e6edf7;border-radius:10px;padding:10px}
  .pill{padding:4px 10px;border-radius:999px;border:1px solid #1f2937;background:#101826;color:#c9d5eb}
  pre{background:#0b1220;border:1px solid #223047;border-radius:10px;padding:10px;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <h1>Mixtli — Test de Subida</h1>
  <p>Prueba de punta a punta (presign → PUT → enlace).</p>

  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <input id="api" value="https://mixtli-pro.onrender.com">
    <button id="go" class="btn">Subir archivo</button>
    <span id="status" class="pill">listo</span>
  </div>

  <input id="file" type="file" style="margin:12px 0" />

  <h3>Debug</h3>
  <pre id="log">—</pre>

  <div id="result"></div>
</div>

<script>
const $ = id => document.getElementById(id);
function log(){ $("log").textContent += Array.from(arguments).join(" ") + "\n"; }

async function doPresign(api, f){
  log("Presign...");
  const r = await fetch(api+"/presign", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ filename:f.name, contentType:f.type, size:f.size })
  });
  log("Presign status:", r.status);
  const txt = await r.text();
  log("Presign body:", txt);
  if(!r.ok) throw new Error("Presign "+r.status);
  return JSON.parse(txt);
}
async function put(url, f){
  log("PUT:", url.slice(0,120)+"...");
  const r = await fetch(url, { method:"PUT", headers:{"Content-Type":f.type}, body:f });
  log("PUT status:", r.status, r.statusText);
  if(!r.ok) throw new Error("PUT "+r.status);
}

$("go").onclick = async ()=>{
  $("log").textContent = ""; $("result").textContent = "";
  const api = $("api").value.replace(/\/$/,"");
  const f = $("file").files[0]; if(!f) return alert("Selecciona un archivo");
  $("status").textContent = "presign...";
  try{
    const p = await doPresign(api, f);
    $("status").textContent = "subiendo...";
    await put(p.url, f);
    const link = p.publicUrl || ("https://pub-f411a341ba7f44a28234293891897c59.r2.dev/" + encodeURIComponent(p.key));
    $("result").innerHTML = '<p>✅ <a href="'+link+'" target="_blank" rel="noopener">Abrir archivo</a></p>';
    $("status").textContent = "listo ✅";
  }catch(e){
    log("Error:", e.message);
    $("status").textContent = "error ❌";
    alert(e.message);
  }
};
</script>
</body>
</html>
